<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
	<title>bone testing</title>
	<script type="text/javascript" src="skel2d.js"></script>
	<style type="text/css">
		html, body, canvas { display: block; margin: 0; padding: 0; width: 100%; height: 100%; }
	</style>
</head>
<body>
<canvas></canvas>
<script type="text/javascript">

var skeleton_data = {
	"bones": [
		{"name": "torso", "length": 100, "rot": 75},
		{"name": "torso.arm_l", "length": 100, "x": 100, "y": 100, "rot": 90, "inhscale": false},
		{"name": "torso.arm_r", "length": 100, "x": 100, "y": -100, "inhrot": false, "flipx": false}
	],

	"slots": [
		{"name": "torso.torso", "color": "FFFFFFFF", "attachment": "torso"}
	],

	"skins": {
		"default": [
			{"name": "torso.torso.torso", "type": "rect", "width": 70, "height": 50, "rot": -90, "y": 35}
		]
	}
};

var animation_data = {
	"bones": {
		"torso": {
			"x": [
				{"time": 0.0, "value": 0, "easing": "sin_in"},
				{"time": 0.5, "value": -50, "easing": "sin_out"},
				{"time": 1.0, "value": 0, "easing": "sin_in"},
				{"time": 1.5, "value": 50, "easing": "sin_out"},
				{"time": 2.0, "value": 0}
			],
			"rot": [
				{"time": 0.0, "value": 0, "easing": "sin_in"},
				{"time": 0.5, "value": -45, "easing": "sin_out"},
				{"time": 1.0, "value": 0, "easing": "sin_in"},
				{"time": 1.5, "value": 45, "easing": "sin_out"},
				{"time": 2.0, "value": 0}
			],
			"flipy": [
				{"time": 0.0, "value": false},
				{"time": 1.0, "value": false},
				{"time": 2.0, "value": false}
			]
		}
	}
};

var canvas = document.querySelector("canvas");
var context = canvas.getContext("2d");
var skeleton = new sk2.Skeleton(skeleton_data);
var animation = new sk2.Animation(skeleton, animation_data);

var S = 10;

var bone_points = [
	{x:  0, y:  S},
	{x:  S, y:  0},
	{x:  0, y: -S},
	{x: -S, y:  0}
];

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

requestAnimationFrame(frame);

// draw(skeleton);

var t0 = 0;
var t1 = 0;
var time = performance.now() / 1000;

function frame()
{
	var t = performance.now() / 1000;
	var dt = t - time;

	time = t;

	t0 = t1;
	t1 = (t1 + dt) % 2.0;

	animation.apply(skeleton, t0, t1, 1);
	skeleton.update_transform();

	draw();

	requestAnimationFrame(frame);
}

function draw()
{
	context.save();
	context.clearRect(0, 0, canvas.width, canvas.height);
	context.translate(Math.floor(canvas.width / 2), Math.floor(canvas.height / 2));
	context.scale(1, -1);

	context.beginPath();
	context.moveTo(0.5, -canvas.height / 2);
	context.lineTo(0.5, canvas.height / 2);
	context.moveTo(-canvas.width / 2, 0.5);
	context.lineTo(canvas.width / 2, 0.5);
	context.stroke();

	draw_skeleton(skeleton);
	context.restore();
}

function draw_skeleton(skeleton)
{
	context.lineWidth = 2;
	context.strokeStyle = "#000";

	context.fillStyle = "#000";

	for (var i = 0, n = skeleton.order.length; i < n; i++)
	{
		var slot = skeleton.slots[skeleton.order[i]];
		var attachment_index = slot.current_state.attachment;

		if (attachment_index >= 0)
		{
			var attachment = skeleton.skins[0].attachments[attachment_index];

			if (attachment.type === sk2.AttachmentRect)
			{
				var srt = slot.bone.world_transform;

				context.save();
				context.transform(srt[0], srt[1], srt[2], srt[3], srt[4], srt[5]);
				context.translate(attachment.x, attachment.y);
				context.rotate(attachment.rot);
				context.scale(attachment.sx, attachment.sy);
				context.fillRect(0, 0, attachment.width, attachment.height);
				context.strokeRect(0, 0, attachment.width, attachment.height);
				context.restore();
			}
		}
	}

	context.fillStyle = "rgba(255, 255, 0, 0.2)";

	for (var i = 0, n = skeleton.bones.length; i < n; i++)
	{
		var bone = skeleton.bones[i];

		var x0 = bone.to_worldx(bone_points[0].x, bone_points[0].y);
		var y0 = bone.to_worldy(bone_points[0].x, bone_points[0].y);

		var x1 = bone.to_worldx(skeleton.bones[i].length, bone_points[1].y);
		var y1 = bone.to_worldy(skeleton.bones[i].length, bone_points[1].y);

		var x2 = bone.to_worldx(bone_points[2].x, bone_points[2].y);
		var y2 = bone.to_worldy(bone_points[2].x, bone_points[2].y);

		var x3 = bone.to_worldx(bone_points[3].x, bone_points[3].y);
		var y3 = bone.to_worldy(bone_points[3].x, bone_points[3].y);

		context.beginPath();
		context.moveTo(x0, y0);
		context.lineTo(x1, y1);
		context.lineTo(x2, y2);
		context.lineTo(x3, y3);
		context.closePath();
		context.fill();
		context.stroke();
	}
}

</script>
</body>
</html>
