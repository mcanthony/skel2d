<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
	<title>bone testing</title>
	<script type="text/javascript" src="anim.js"></script>
	<style type="text/css">
		html, body, canvas { display: block; margin: 0; padding: 0; width: 100%; height: 100%; }
	</style>
</head>
<body>
<canvas></canvas>
<script type="text/javascript">

var canvas = document.querySelector("canvas");
var context = canvas.getContext("2d");
var skeleton = create_skeleton();
var animation = create_animation();

var S = 10;

var bone_points = [
	{x:  0, y:  S},
	{x:  S, y:  0},
	{x:  0, y: -S},
	{x: -S, y:  0}
];

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

requestAnimationFrame(frame);

function frame()
{
	var t = (performance.now() / 1000) % 2;

	animation.apply(skeleton, t, t, 1);
	skeleton.update_transform();

	draw();

	requestAnimationFrame(frame);
}

function draw()
{
	context.save();
	context.clearRect(0, 0, canvas.width, canvas.height);
	context.translate(Math.floor(canvas.width / 2), Math.floor(canvas.height / 2));
	context.scale(1, -1);

	context.beginPath();
	context.moveTo(0.5, -canvas.height / 2);
	context.lineTo(0.5, canvas.height / 2);
	context.moveTo(-canvas.width / 2, 0.5);
	context.lineTo(canvas.width / 2, 0.5);
	context.stroke();

	draw_skeleton(skeleton);
	context.restore();
}

function create_skeleton()
{
	var skeleton = new Skeleton();
	var torso = new Bone();
	var arm_l = new Bone();
	var arm_r = new Bone();

	torso.skeleton = skeleton;
	arm_l.skeleton = skeleton;
	arm_r.skeleton = skeleton;

	arm_l.parent = torso;
	arm_r.parent = torso;

	torso.length = 100;
	arm_l.length = 100;
	arm_r.length = 100;

	torso.initial_state.rot =  Pi / 2 + (Pi / 8) * 0;
	arm_l.initial_state.rot =  Pi / 2;
	// arm_r.initial_state.rot = -Pi / 2;
	arm_r.inherit_rotation = false;

	arm_l.initial_state.x = 100;
	arm_r.initial_state.x = 100;
	arm_l.initial_state.y = 100;
	arm_r.initial_state.y = -100;

	skeleton.bones.push(torso);
	skeleton.bones.push(arm_l);
	skeleton.bones.push(arm_r);

	skeleton.reset();
	skeleton.update_transform();

	return skeleton;
}

function create_animation()
{
	var animation = new Animation();

	// torso position.x timeline

	var timeline = new Timeline();

	animation.timelines.push(timeline);

	timeline.index = 0;
	timeline.property = PropBoneX;
	timeline.keyframes.push(new Keyframe());
	timeline.keyframes.push(new Keyframe());
	timeline.keyframes.push(new Keyframe());
	timeline.keyframes.push(new Keyframe());
	timeline.keyframes.push(new Keyframe());

	timeline.keyframes[0].time = 0;
	timeline.keyframes[0].value = 0;
	timeline.keyframes[0].interpolator = function(x) { return Math.sin(x * Pi/2); };

	timeline.keyframes[1].time = 0.5;
	timeline.keyframes[1].value = -50;
	timeline.keyframes[1].interpolator = function(x) { return 1 - Math.sin(Pi/2 + x * Pi/2); };

	timeline.keyframes[2].time = 1.0;
	timeline.keyframes[2].value = 0;
	timeline.keyframes[2].interpolator = function(x) { return Math.sin(x * Pi/2); };

	timeline.keyframes[3].time = 1.5;
	timeline.keyframes[3].value = 50;
	timeline.keyframes[3].interpolator = function(x) { return 1 - Math.sin(Pi/2 + x * Pi/2); };

	timeline.keyframes[4].time = 2.0;
	timeline.keyframes[4].value = 0;

	// torso rotation timeline

	timeline = new Timeline();

	animation.timelines.push(timeline);

	timeline.index = 0;
	timeline.property = PropBoneRot;
	timeline.keyframes.push(new Keyframe());
	timeline.keyframes.push(new Keyframe());
	timeline.keyframes.push(new Keyframe());
	timeline.keyframes.push(new Keyframe());
	timeline.keyframes.push(new Keyframe());

	timeline.keyframes[0].time = 0;
	timeline.keyframes[0].value = 0;
	timeline.keyframes[0].interpolator = function(x) { return Math.sin(x * Pi/2); };

	timeline.keyframes[1].time = 0.5;
	timeline.keyframes[1].value = -Pi/4;
	timeline.keyframes[1].interpolator = function(x) { return 1 - Math.sin(Pi/2 + x * Pi/2); };

	timeline.keyframes[2].time = 1.0;
	timeline.keyframes[2].value = 0;
	timeline.keyframes[2].interpolator = function(x) { return Math.sin(x * Pi/2); };

	timeline.keyframes[3].time = 1.5;
	timeline.keyframes[3].value = Pi/4;
	timeline.keyframes[3].interpolator = function(x) { return 1 - Math.sin(Pi/2 + x * Pi/2); };

	timeline.keyframes[4].time = 2.0;
	timeline.keyframes[4].value = 0;

	return animation;
}

function draw_skeleton(skeleton)
{
	context.lineWidth = 2;
	context.strokeStyle = "#000";
	context.fillStyle = "rgba(255, 255, 0, 0.2)";

	for (var i = 0, n = skeleton.bones.length; i < n; i++)
	{
		var transform = skeleton.bones[i].world_transform;

		var x0 = mat2d_mulx(transform, bone_points[0].x, bone_points[0].y);
		var y0 = mat2d_muly(transform, bone_points[0].x, bone_points[0].y);

		var x1 = mat2d_mulx(transform, skeleton.bones[i].length, bone_points[1].y);
		var y1 = mat2d_muly(transform, skeleton.bones[i].length, bone_points[1].y);

		var x2 = mat2d_mulx(transform, bone_points[2].x, bone_points[2].y);
		var y2 = mat2d_muly(transform, bone_points[2].x, bone_points[2].y);

		var x3 = mat2d_mulx(transform, bone_points[3].x, bone_points[3].y);
		var y3 = mat2d_muly(transform, bone_points[3].x, bone_points[3].y);

		context.beginPath();
		context.moveTo(x0, y0);
		context.lineTo(x1, y1);
		context.lineTo(x2, y2);
		context.lineTo(x3, y3);
		context.closePath();
		context.fill();
		context.stroke();
	}
}

</script>
</body>
</html>