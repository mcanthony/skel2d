<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
	<title>skel2d</title>
	<script type="text/javascript" src="../src/skel2d.js"></script>
	<style type="text/css">
		html, body, canvas { display: block; margin: 0; padding: 0; width: 100%; height: 100%; }
	</style>
</head>
<body>
<canvas></canvas>
<script type="text/javascript">

var skeleton_data = {
	"bones": [
		{"name": "torso", "length": 100, "rot": 90},
		{"name": "torso.arm_l", "length": 50, "x": 100, "y": 60, "rot": 115, "sx": 1.3},
		{"name": "torso.arm_l.forearm", "length": 50, "x": 50, "y": 0, "rot": 130},
		{"name": "torso.arm_r", "length": 50, "x": 100, "y": -60, "rot": -50},
		{"name": "torso.arm_r.forearm", "length": 50, "x": 50, "y": 0, "rot": 40},
		{"name": "torso.leg_l", "length": 50, "x": 0, "y": 60, "rot": 170},
		{"name": "torso.leg_l.lower_leg", "length": 50, "x": 50, "y": 0, "rot": 10},
		{"name": "torso.leg_r", "length": 50, "x": 0, "y": -60, "rot": -170},
		{"name": "torso.leg_r.lower_leg", "length": 50, "x": 50, "y": 0, "rot": -10}
	],

	"slots": [
		{"name": "torso.torso", "attachment": "torso"},
		{"name": "torso.arm_l.arm", "attachment": "arm"},
		{"name": "torso.arm_r.arm", "attachment": "arm"},
		{"name": "torso.leg_l.leg", "attachment": "leg"},
		{"name": "torso.leg_r.leg", "attachment": "leg"}
	],

	"skins": {
		"default": [
			{"name": "torso.torso.torso", "type": "rect", "line_width": 4, "fill_color": "0000FFFF",
			"width": 120, "height": 100, "rot": -90, "y": 60},

			{"name": "torso.arm_l.arm.arm", "type": "path", "line_width": 4, "commands": [
				"M", 0, 0, "torso.arm_l",
				"Q", 50, 0, "torso.arm_l", 50, 0, "torso.arm_l.forearm"
			]},

			{"name": "torso.arm_r.arm.arm", "type": "path", "line_width": 4, "commands": [
				"M", 0, 0, "torso.arm_r",
				"Q", 50, 0, "torso.arm_r", 50, 0, "torso.arm_r.forearm"
			]},

			{"name": "torso.leg_r.leg.leg", "type": "path", "line_width": 4, "commands": [
				"M", 0, 0, "torso.leg_r",
				"Q", 50, 0, "torso.leg_r", 50, 0, "torso.leg_r.lower_leg"
			]},

			{"name": "torso.leg_l.leg.leg", "type": "path", "line_width": 4, "commands": [
				"M", 0, 0, "torso.leg_l",
				"Q", 50, 0, "torso.leg_l", 50, 0, "torso.leg_l.lower_leg"
			]}
		]
	}
};

var animation_data = {
	"bones": {
		"torso.arm_r.forearm": {
			"rot": [
				{"time": 0.0 / 2, "value": 0, "easing": "sin_in"},
				{"time": 0.5 / 2, "value": -30, "easing": "sin_out"},
				{"time": 1.0 / 2, "value": 0, "easing": "sin_in"},
				{"time": 1.5 / 2, "value": 30, "easing": "sin_out"},
				{"time": 2.0 / 2, "value": 0, "easing": "sin_in"},
				{"time": 2.5 / 2, "value": -30, "easing": "sin_out"},
				{"time": 3.0 / 2, "value": 0, "easing": "sin_in"},
				{"time": 3.5 / 2, "value": 30, "easing": "sin_out"},
				{"time": 4.0 / 2, "value": 0}
			]
		}
	}
};

var canvas = document.querySelector("canvas");
var context = canvas.getContext("2d");
var skeleton = new sk2.Skeleton(skeleton_data);
var animation = new sk2.Animation(skeleton, animation_data);

var S = 5;

var bone_points = [
	{x:  0, y:  S},
	{x:  S, y:  0},
	{x:  0, y: -S},
	{x: -S, y:  0}
];

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

requestAnimationFrame(frame);

// draw(skeleton);

var t0 = 0;
var t1 = 0;
var time = performance.now() / 1000;

function frame()
{
	var t = performance.now() / 1000;
	var dt = t - time;

	time = t;

	t0 = t1;
	t1 = (t1 + dt) % 2.0;

	animation.apply(skeleton, t0, t1, 1);
	skeleton.update_transform();

	draw();

	requestAnimationFrame(frame);
}

function draw()
{
	context.save();
	context.clearRect(0, 0, canvas.width, canvas.height);
	context.translate(Math.floor(canvas.width / 2), Math.floor(canvas.height / 2));
	context.scale(1, -1);

	context.beginPath();
	context.moveTo(0.5, -canvas.height / 2);
	context.lineTo(0.5, canvas.height / 2);
	context.moveTo(-canvas.width / 2, 0.5);
	context.lineTo(canvas.width / 2, 0.5);
	context.lineWidth = 1;
	context.stroke();

	draw_skeleton(skeleton);
	context.restore();
}

function to_style(color)
{
	return "rgba(" +
		(color.r * 255) + "," +
		(color.g * 255) + "," +
		(color.b * 255) + "," +
		(color.a) +
	")";
}

function draw_skeleton(skeleton)
{
	context.lineCap = "round";

	for (var i = 0, n = skeleton.order.length; i < n; i++)
	{
		var slot = skeleton.slots[skeleton.order[i]];
		var attachment_index = slot.current_state.attachment;

		if (attachment_index >= 0)
		{
			var attachment = skeleton.skins[0].attachments[attachment_index];

			if (attachment.type === sk2.AttachmentRect)
			{
				var srt = slot.bone.world_transform;

				context.save();
				context.transform(srt[0], srt[1], srt[2], srt[3], srt[4], srt[5]);
				context.translate(attachment.x, attachment.y);
				context.rotate(attachment.rot);
				context.scale(attachment.sx, attachment.sy);

				context.fillStyle = to_style(attachment.fill_color);
				context.fillRect(0, 0, attachment.width, attachment.height);

				if (attachment.line_width > 0)
				{
					context.lineWidth = attachment.line_width;
					context.strokeStyle = to_style(attachment.line_color);
					context.strokeRect(0, 0, attachment.width, attachment.height);
				}

				context.restore();
			}
			else if (attachment.type === sk2.AttachmentPath)
			{
				var commands = attachment.commands;
				var points = attachment.points;
				var ncommands = commands.length;

				context.beginPath();

				for (var j = 0, k = 0; j < ncommands; j++)
				{
					switch (commands[j])
					{
						case "M":
						{
							var p = points[k++];
							var bone = skeleton.bones[p.bone];
							var x = bone.to_worldx(p.x, p.y);
							var y = bone.to_worldy(p.x, p.y);

							context.moveTo(x, y);
						}
						break;

						case "L":
						{
							var p = points[k++];
							var bone = skeleton.bones[p.bone];
							var x = bone.to_worldx(p.x, p.y);
							var y = bone.to_worldy(p.x, p.y);

							context.lineTo(x, y);
						}
						break;

						case "B":
						{
							var p1 = points[k++];
							var p2 = points[k++];
							var p3 = points[k++];

							var bone1 = skeleton.bones[p1.bone];
							var bone2 = skeleton.bones[p2.bone];
							var bone3 = skeleton.bones[p3.bone];

							var x1 = bone1.to_worldx(p1.x, p1.y);
							var y1 = bone1.to_worldy(p1.x, p1.y);
							var x2 = bone2.to_worldx(p2.x, p2.y);
							var y2 = bone2.to_worldy(p2.x, p2.y);
							var x3 = bone3.to_worldx(p3.x, p3.y);
							var y3 = bone3.to_worldy(p3.x, p3.y);

							context.bezierCurveTo(x1, y1, x2, y2, x3, y3);
						}
						break;

						case "Q":
						{
							var p1 = points[k++];
							var p2 = points[k++];

							var bone1 = skeleton.bones[p1.bone];
							var bone2 = skeleton.bones[p2.bone];

							var x1 = bone1.to_worldx(p1.x, p1.y);
							var y1 = bone1.to_worldy(p1.x, p1.y);
							var x2 = bone2.to_worldx(p2.x, p2.y);
							var y2 = bone2.to_worldy(p2.x, p2.y);

							context.quadraticCurveTo(x1, y1, x2, y2);
						}
						break;

						case "C":
							context.closePath();
							break;
					}
				}

				context.lineWidth = attachment.line_width;
				context.strokeStyle = to_style(attachment.line_color);
				context.stroke();
			}
		}
	}

	context.lineWidth = 1;
	context.fillStyle = "rgba(255, 255, 0, 0.5)";
	context.strokeStyle = "#000";

	for (var i = 0, n = skeleton.bones.length; i < n; i++)
	{
		var bone = skeleton.bones[i];

		var x0 = bone.to_worldx(bone_points[0].x, bone_points[0].y);
		var y0 = bone.to_worldy(bone_points[0].x, bone_points[0].y);

		var x1 = bone.to_worldx(skeleton.bones[i].length, bone_points[1].y);
		var y1 = bone.to_worldy(skeleton.bones[i].length, bone_points[1].y);

		var x2 = bone.to_worldx(bone_points[2].x, bone_points[2].y);
		var y2 = bone.to_worldy(bone_points[2].x, bone_points[2].y);

		var x3 = bone.to_worldx(bone_points[3].x, bone_points[3].y);
		var y3 = bone.to_worldy(bone_points[3].x, bone_points[3].y);

		context.beginPath();
		context.moveTo(x0, y0);
		context.lineTo(x1, y1);
		context.lineTo(x2, y2);
		context.lineTo(x3, y3);
		context.closePath();
		context.fill();
		context.stroke();
	}
}

</script>
</body>
</html>
