<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<title>Skel2D</title>
<script type="text/javascript" src="ace/ace.js"></script>
<script type="text/javascript" src="src/gfx.js"></script>
<script type="text/javascript" src="src/gfx_path.js"></script>
<script type="text/javascript" src="src/skel2d.js"></script>
<script type="text/javascript" src="src/skel2d_render.js"></script>
<script type="text/javascript" src="src/skel2d_parser.js"></script>
<style type="text/css">
html, body { margin: 0; padding: 0; width: 100%; height: 100%; }
#code { position: absolute; top: 0; bottom: 0; width: 610px; }
#code { border-right: 1px solid #666; display: none; }
#canvas { position: absolute; top: 0; bottom: 0; left: 611px; right: 0; }
canvas { display: block; width: 100%; height: 100%; }
.ace_bracket {border: none!important;}
.ace_cursor {border-left-width: 1px!important;}
</style>
</head>
<body>
<div id="canvas"><canvas></canvas></div>
<div id="code"></div>
<script type="text/javascript">

var editor = ace.edit("code");
var canvas = document.querySelector("canvas");
var gfx = gfx_create_context(canvas);
var renderer = new SkeletonRenderer(gfx);
var skeleton = null;
var update_timer = null;

window.addEventListener("resize", resize);

window.addEventListener("beforeunload", function() {
	localStorage.setItem("testcode", editor.session.getValue());
});

editor.session.setTabSize(2);
editor.session.setUseSoftTabs(false);
editor.setOption("fixedWidthGutter", true);
editor.setOption("displayIndentGuides", false);
editor.$blockScrolling = Infinity;

var code = localStorage.getItem("testcode");

if (code)
{
	editor.session.setValue(code);
	editor.session.selection.clearSelection();
}

editor.session.on("change", function() {
	if (update_timer !== null)
		clearTimeout(update_timer);

	update_timer = setTimeout(update, 1000);
});

document.querySelector("#code").style.display = "block";
editor.focus();

gfx.clear_color(1, 1, 1, 1);

resize();
update();

function update()
{
	update_timer = null;

	var data = skel2d_parse(editor.session.getValue());
	skeleton = new sk2.Skeleton(data);

	draw();
}

function resize()
{
	var w = canvas.width = canvas.offsetWidth;
	var h = canvas.height = canvas.offsetHeight;

	gfx.viewport(0, 0, canvas.width, canvas.height);
	gfx.projection(mat3ortho(-w/2, w/2, -h/2, h/2, mat3()));

	draw();
}

function draw()
{
	gfx.clear();

	if (skeleton)
		renderer.draw(skeleton, 1);
}

</script>
</body>
</html>