<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<title>Skel2D</title>
<script type="text/javascript" src="src/ace.js"></script>
<script type="text/javascript" src="src/ace_skel2d.js"></script>
<script type="text/javascript" src="src/gfx.js"></script>
<script type="text/javascript" src="src/gfx_path.js"></script>
<script type="text/javascript" src="src/skel2d_core.js"></script>
<script type="text/javascript" src="src/skel2d_render.js"></script>
<script type="text/javascript" src="src/skel2d_parser.js"></script>
<style type="text/css">
html, body { margin: 0; padding: 0; width: 100%; height: 100%; }
#code { position: absolute; top: 0; bottom: 0; width: 610px; }
#code { border-right: 1px solid #666; display: none; }
#canvas { position: absolute; top: 0; bottom: 0; left: 611px; right: 0; }
canvas { display: block; width: 100%; height: 100%; user-select: none; }

.ace-tm .ace_marker-layer .ace_bracket { border-width: 0;border-style: none; }
.ace_hidden-cursors .ace_cursor {display: none;}
.ace_cursor { border-left-width: 1px; }
.ace_editor.ace_multiselect .ace_overwrite-cursors .ace_cursor { border-left-width: 0px; }

.ace-tm { color:#999; }
.ace-tm .ace_keyword { color:#00F; }
.ace-tm .ace_invalid { background-color: transparent; color: #F00; text-decoration: line-through; }
.ace_bone { color: #00F; }
.ace_slot { color: #09F; }
.ace_property { color: #000; }
.ace_value { color: #777; }
.ace_attachment-type { color: #F00; }
.ace_command { color: #000; }

</style>
</head>
<body>
<div id="canvas"><canvas></canvas></div>
<div id="code"></div>
<script type="text/javascript">

var editor = create_editor();
var canvas = document.querySelector("canvas");
var gfx = gfx_create_context(canvas);
var renderer = new SkeletonRenderer(gfx);
var skeleton = null;
var animation = null;
var parsed_data = null;

var t0 = 0;
var t1 = 0;
var time = 0;
var frame_id = 0;

window.addEventListener("resize", resize);
canvas.addEventListener("mousedown", function(e) { e.preventDefault(); });

gfx.clear_color(1, 1, 1, 1);
resize();
update();
editor.focus();

function create_editor()
{
	var editor = ace.edit("code");
	var code = localStorage.getItem("testcode") || "";

	editor.renderer.$updateScrollBarV = function() {
		this.scrollBarV.setScrollHeight(this.layerConfig.maxHeight + this.scrollMargin.v);
		this.scrollBarV.setScrollTop(this.scrollTop + this.scrollMargin.top);
	};

	editor.$blockScrolling = Infinity;
	editor.session.setTabSize(2);
	editor.session.setUseSoftTabs(false);
	editor.session.setMode(new (require("ace/mode/skel2d").Mode)());
	editor.setOption("fixedWidthGutter", true);
	editor.setOption("displayIndentGuides", false);
	editor.setOption("scrollPastEnd", 1);
	editor.setValue(code);
	editor.clearSelection();

	editor.session.on("change", function() {
		var timer = null;

		function trigger_update() {
			timer = null;
			update();
		}

		return function() {
			if (timer !== null)
				clearTimeout(timer);

			timer = setTimeout(trigger_update, 1000);
		};
	}());

	window.addEventListener("beforeunload", function() {
		localStorage.setItem("testcode", editor.getValue());
	});

	var commands_remove = [
		"showSettingsMenu", "goToNextError", "goToPreviousError", "centerselection",
		"gotoline", "fold", "unfold", "toggleFoldWidget", "toggleParentFoldWidget",
		"foldall", "foldOther", "unfoldall", "findnext", "findprevious",
		"selectOrFindNext", "selectOrFindPrevious", "find", "togglerecording",
		"replaymacro", "jumptomatching", "selecttomatching", "expandToMatching",
		"sortlines", "togglecomment", "toggleBlockComment", "modifyNumberUp",
		"modifyNumberDown", "replace", "copylinesup", "copylinesdown",
		"splitline", "transposeletters", "expandtoline", "selectMoreBefore",
		"selectNextBefore", "selectMoreAfter"
	];

	var commands_remap = [
		"removeline", "movelinesup", "movelinesdown", "joinlines", "splitIntoLines",
		"findAll", "selectNextAfter"
	];

	for (var i = 0, n = commands_remove.length; i < n; i++)
		editor.commands.removeCommand(commands_remove[i]);

	for (var i = 0, n = commands_remap.length; i < n; i++)
		editor.commands.removeCommand(commands_remap[i], true);

	editor.commands.addCommand({
		name: "selectMoreAfter",
		exec: function(editor) { editor.selectMore(1, false, true); },
		scrollIntoView: "cursor",
		readonly: true
	});

	editor.commands.bindKey("ctrl+shift+k",     editor.commands.commands["removeline"]);
	editor.commands.bindKey("ctrl+shift+up",    editor.commands.commands["movelinesup"]);
	editor.commands.bindKey("ctrl+shift+down",  editor.commands.commands["movelinesdown"]);
	editor.commands.bindKey("ctrl+j",           editor.commands.commands["joinlines"]);
	editor.commands.bindKey("ctrl+shift+l",     editor.commands.commands["splitIntoLines"]);
	editor.commands.bindKey("alt+f3",           editor.commands.commands["findAll"]);
	editor.commands.bindKey("ctrl+d",           editor.commands.commands["selectMoreAfter"]);
	editor.commands.bindKey("ctrl+k",           editor.commands.commands["selectNextAfter"]);

	document.querySelector("#code").style.display = "block";
	return editor;
}

function update()
{
	parsed_data = skel2d_parse(editor.getValue());
	skeleton = new sk2.Skeleton(parsed_data.skeleton);
	animation = null;

	if (parsed_data.animations.length > 0)
	{
		animation = new sk2.Animation(skeleton, parsed_data.animations[0]);

		if (frame_id !== 0 && animation.duration === 0)
		{
			cancelAnimationFrame(frame_id);
			frame_id = 0;
		}
		else if (frame_id === 0 && animation.duration > 0)
		{
			t0 = t1 = 0;
			time = performance.now() / 1000;
			frame_id = requestAnimationFrame(anim_frame);
		}
	}
	else
	{
		if (frame_id !== 0)
		{
			cancelAnimationFrame(frame_id);
			frame_id = 0;
		}

		draw();
	}
}

function anim_frame()
{
	var t = performance.now() / 1000;
	var dt = t - time;

	time = t;

	t0 = t1;
	t1 = (t1 + dt) % animation.duration;

	animation.apply(skeleton, t0, t1, 1);
	skeleton.update_transform();

	draw();

	frame_id = requestAnimationFrame(anim_frame);
}

function resize()
{
	var w = canvas.width = canvas.offsetWidth;
	var h = canvas.height = canvas.offsetHeight;

	gfx.viewport(0, 0, w, h);
	gfx.projection(mat3ortho(0, w, 0, h, mat3()));

	draw();
}

function draw()
{
	gfx.clear();

	if (skeleton)
		renderer.draw(skeleton, canvas.width / 2, canvas.height / 2, 1);
}

</script>
</body>
</html>